+++
title = "Android Pentest"
date = "2021-04-02"
categories = [
    "security",
]
+++
## Bypass SSL pinning

### Install Burpsuite’s certificate to system store

1. Export certificate with `Certificate in DER format` option and named `burp.der`
2. Convert certificate to crt/pem format: `openssl x509 -in burp.der -inform DER -out burp.crt`
3. Rename to `<hash>.0`, get hash: `openssl x509 -inform PEM -subject_hash_old -in burp.crt | head -n 1`
rename: `mv burp.crt 9a5ba575.0`
4. Backup existing certs: `adb shell "cp /system/etc/security/cacerts/* /tmp"`
5. Create an in-memory mount: `adb shell "mount -t tmpfs tmpfs /system/etc/security/cacerts"`
6. Copy the existing certs back into the tmpfs mount: `adb shell "mv /tmp/*.0 /system/etc/security/cacerts/"` 
7. Push `burp.crt` into cacerts folder: `adb push 9a5ba575.0 /system/etc/security/cacerts/`
8. Update the perms, so everything is as readable as before.
```bash
adb shell "chown root:root /system/etc/security/cacerts/*
chmod 644 /system/etc/security/cacerts/*
chcon u:object_r:system_file:s0 /system/etc/security/cacerts/*"
```

**Auto.sh**: export burp suite certificate and named `burp.der`

```bash
openssl x509 -in burp.der -inform DER -out burp.crt
hash=`openssl x509 -inform PEM -subject_hash_old -in burp.crt | head -n 1`.0
mv burp.crt $hash
adb shell "cp /system/etc/security/cacerts/* /tmp
mount -t tmpfs tmpfs /system/etc/security/cacerts
mv /tmp/*.0 /system/etc/security/cacerts/"
adb push $hash /system/etc/security/cacerts/
adb shell "chown root:root /system/etc/security/cacerts/*
chmod 644 /system/etc/security/cacerts/*
chcon u:object_r:system_file:s0 /system/etc/security/cacerts/*"
```

### Bypass SSL Pinning by hooking with Frida

Start Frida in the device: 

```bash
adb push frida-server-14.2.13-android-x86 /data/local/tmp/frida-server-14.2.13-android-x86
adb shell "chmod +x /data/local/tmp/frida-server-14.2.13-android-x86; /data/local/tmp/frida-server-14.2.13-android-x86 &"
sudo ifconfig vboxnet0 inet 192.168.56.104 # connect to vboxnet0 in case linux not automatic connect
```

Then custom a script to hook, E.g:

https://codeshare.frida.re/@avltree9798/universal-android-ssl-pinning-bypass

https://codeshare.frida.re/@sowdust/universal-android-ssl-pinning-bypass-2

```bash
frida --codeshare sowdust/universal-android-ssl-pinning-bypass-2 -f com.android.vnsomthing
```

```java
Java.perform(function() {
    var array_list = Java.use("java.util.ArrayList");
    var ApiClient = Java.use('com.android.org.conscrypt.TrustManagerImpl');
    ApiClient.checkTrustedRecursive.implementation = function(a1, a2, a3, a4, a5, a6) {
        console.log('Bypassing SSL Pinning');
        var k = array_list.$new();
        return k;
    }
}, 0);
```

Script from my mentor Khuyenn: https://gitlab.com/laladee/scripts/-/blob/master/python/frida_hooking.py

Hook is great way to spy on crypto APIs and trace application code, to access running application, change values, extract values, run different code,...

### Auto Bypass SSL Pinning with objection

> The **goal** of **objection** is let the user call the **main actions that offers Frida**. **Otherwise**, the user will need to create a **single script for every application** that he wants to test.

https://github.com/sensepost/objection/wiki

Start Frida in the device:

```bash
adb push frida-server-14.2.13-android-x86 /data/local/tmp/frida-server-14.2.13-android-x86
adb shell "chmod +x /data/local/tmp/frida-server-14.2.13-android-x86; /data/local/tmp/frida-server-14.2.13-android-x86 &"
```

Hooking with objection

```bash
pip3 install objection
objection --gadget com.package.app explore --startup-command "android sslpinning disable"
```

Some commands:

```bash
anv
android root disable
android hooking list activities
```
### Auto re-patch with apk-mitm and reFlutter

https://github.com/shroudedcode/apk-mitm

```bash
npm install -g apk-mitm
```

```bash
$ apk-mitm example.apk

  ✔ Decoding APK file
  ✔ Modifying app manifest
  ✔ Replacing network security config
  ✔ Disabling certificate pinning
  ✔ Encoding patched APK file
  ✔ Signing patched APK file

   Done!  Patched APK: ./example-patched.apk
```

With Flutter apps:

https://github.com/Impact-I/reFlutter

```bash
pip3 install reflutter
```

```bash
$ reflutter main.apk

Please enter your Burp Suite IP: <input_ip>

SnapshotHash: 8ee4ef7a67df9845fba331734198a953
The resulting apk file: ./release.RE.apk
Please sign the apk file

Configure Burp Suite proxy server to listen on *:8083
Proxy Tab -> Options -> Proxy Listeners -> Edit -> Binding Tab

Then enable invisible proxying in Request Handling Tab
Support Invisible Proxying -> true
```



## APK Patching - Decompile and Recompile

Decompile:

```bash
apktool d base.apk
# or to avoid resource error when recompile:
apktool d -f -r base.apk
```

Recompile (the output at `dist` directory):

```bash
apktool b base
```

Signing:

```bash
keytool -genkey -v -keystore my-release-key.keystore -alias alias_name -keyalg RSA -keysize 2048 -validity 10000
jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore my-release-key.keystore base.apk alias_name
```

